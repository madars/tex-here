#!/bin/bash
# usage: tex-here <document-name> [workspace-for-shell] [workspace-for-editor] [workspace-for-pdf-viewer]
DOC_NAME=${1%.tex}
SHELL_WORKSPACE_ID=$(workspace-name-to-id ${2:-m1})
EDITOR_WORKSPACE_ID=$(workspace-name-to-id ${3:-c1})
PDF_VIEWER_WORKSPACE_ID=$(workspace-name-to-id ${4:-c2})

HELPER_SCRIPT=`mktemp -t tex-here-$DOC_NAME-helper-XXX`

chmod +x $HELPER_SCRIPT
cat > $HELPER_SCRIPT <<EOF
#!/bin/sh
trap "{ rm $HELPER_SCRIPT }" EXIT

# create an empty PDF, to be replaced in the compilation process
echo "%!PS\nshowpage\n%%EOF" | ps2pdf - $DOC_NAME.pdf
# set it to have placeholder outline (/Title), open at page 1
# (/PageMode /Page 1), outlines open (/UseOutlines), fitting page bounding
# box to the window (/FitB), and continuous (/OneColumn)
# http://extras.springer.com/1998/978-3-642-72032-1/PDF/PRIMER.PDF
# https://www.tug.org/applications/hyperref/manual.html
gs \
   -q -dBATCH -dNOPAUSE \
   -o $DOC_NAME.pdf \
   -sDEVICE=pdfwrite \
   -c "[ /Title (Title Page) /Page 1 /OUT pdfmark" \
   -c "[ /PageMode /UseOutlines /Page 1 /View [ /FitB ] /DOCVIEW pdfmark" \
   -c "[ {Catalog} << /PageLayout /OneColumn >> /PUT pdfmark" \
   -f $DOC_NAME.pdf

# xdg-open associations are hard to change so just hard-code evince
evince $DOC_NAME.pdf &

# If your PDF viewer does not take focus you can also try 
# xdotool search --class ... (for class found by xprop or xwininfo)
sleep 0.5; wmctrl -r :ACTIVE: -t $PDF_VIEWER_WORKSPACE_ID

$EDITOR $DOC_NAME.tex &
# Ideally we'd like to switch window opened by the child process, not
# the active window. In case of emacs the window is controlled by
# the master emacs process, not the emacsclient whose PID we'd get, so
# we switch the active window.
sleep 0.5; wmctrl -r :ACTIVE: -t $EDITOR_WORKSPACE_ID
wmctrl -s $EDITOR_WORKSPACE_ID

# latexrun --clean-all
mkdir -p latex.out
rm -f $DOC_NAME.synctex.gz
ln -sfn latex.out/$DOC_NAME.synctex.gz $DOC_NAME.synctex.gz

while true; do
      clear
      echo [+] Started: \$(date "+%Y-%m-%d %H:%M:%S")
      latexrun \
         --latex-args="-synctex=1" \
         $DOC_NAME
      echo [+] Done: \$(date "+%Y-%m-%d %H:%M:%S")
      jq --raw-output \
         '.tasks | .[] | .deps | map(select(.[0] == "file")) | .[] | .[1] | .[]' \
         latex.out/.latexrun.db > latex.out/.tex-here.depends
      echo ""
      inotifywait \
         --quiet \
         --fromfile latex.out/.tex-here.depends \
         --event modify,move_self,delete_self,unmount
      sleep 1
done
read _
EOF

wmctrl -r :ACTIVE: -t $SHELL_WORKSPACE_ID

tmux \
    new-session -s tex-$DOC_NAME -n compile $HELPER_SCRIPT \; \
    new-window -n prog 'git-progress loop' \; \
    select-window -t compile
